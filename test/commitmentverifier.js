// Copyright (c) 2016-2018 Clearmatics Technologies Ltd
// SPDX-License-Identifier: LGPL-3.0+

/*
    Ion Mediator contract test

    Tests here are standalone unit tests for Ion functionality.
    Other contracts have been mocked to simulate basic behaviour.

    Tests the central mediator for block passing and validation registering.
*/

const Verifier = artifacts.require("ZethCommitmentEventVerifier");

require('chai')
 .use(require('chai-as-promised'))
 .should();


EXPECTED_COMMITMENTS = [
    {
        "contract_address": "0xb0423e6e54afea1658ce4ced53971575c99d6cad",
        "receipt": "0xf9070901831b4254b9010000400000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000008000000000000000000000000820000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000020000000040000000000000000000000880000000000800000000f905fef85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba043cbead5e9cdd6fef63d3c51cd82da287795b2a519273f39ec526e11969bccecf85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba091d0383df14829a9f6c505ee14de8c05c3fab62b2b44954f14b0c7dc9c4fe55ef87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000000934ec443eafd5ab2fa6e8db57d9bea0a334013eaac35f028e7da41711ca2fb28f87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000001da8099cad6b92df9fc36a552a23445ae60527cba86362fb0b53c9691eb4d62f3f85894b0423e6e54afea1658ce4ced53971575c99d6cade1a048ea34bbce4a95382a77a55f86a31c66a0719a0d4baed17727e5b0276ebb6e7ba00f7eac23578c0e30e52a12fe217538a51b52281c14e5b8e7f331a23257075bb5f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a0ab894f958fb0dddc50af77f5a19e18b590035cb8eed8c469ec21ffda0ccc56acb01374627f2e2ddd386e1e5b0d04a22cf4aa16af297f7723e71963b1762f269cea128da6371fd65248541c1247989acf7bd1ba0917bfe5a35561f85d95b6c8be8a0d32b922672210052c4b0f806f0b902de795eaae57091c85d38a368c7d329084ddd98a69a324e636efce637ea149a0f537fe8242005f8284f26dda2d2f56d80df22bef32626d018566549ddeaab5ef3434439effcc05173f3dbc564122f854f3c9e89ec4576661e783c1bf760fd103efc1c2157e1a4bff1e62feb675c26811555bd4a929feef9f66b67ce1376a860e417fd179d62dee3344d72417cbd3feabc18e0f83c00af15a81a0944d6e2d020a7adbd844336fa87dd573f3ac9d8233037acc07cdf380ed7cda4b710a931830659dbee22ec25f1c551c169d7e8d752eb1b33c5fbd7134e037aee00000000000000000000000000000000000000000000f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a7548f71df3b0ab6f0f9cbe7b6e8032a6f7190083f8d7d9fc2ab760ce2f0d8f6d5c030184ac07cdc497e6ac98097270c0ad8deab9b22e2d21c56c65317325b098c9ebc44c42189916a8aef5eec3e7ef7d846f84dac75dbf0de9a7e5f557cf6b486130535a46f80abfac7b32c9e7393128ea275446758cd10e48ec487565368d3cbb1b681287b64faa50742cf5a3463be5bf30503899ad9c209db28922a7dc7c3c7e074d103cc7a70f1c8f382bc841555f0dac78330dbbd8449a027dff92e8c5d0aeb46f95bf452fdf77d5a3031d282eab4fc647d1e94879d210311d4013d3cdf7f5dc78ea3f9393850b9112c3b3dafe8a992e9b72473629d5c05d6a555824c1a99fb356491741783e3107e590b637dfbd2ee76a797656e2a80d944774223c48d48deffe5f48cfc4c93928d562c3d7e860866b70b690202afa2391faf780a55fe0c8bb8725010f03de066b00000000000000000000000000000000000000000000",
        "address": "1",
        "commitment": "0xda8099cad6b92df9fc36a552a23445ae60527cba86362fb0b53c9691eb4d62f3"
    },
    {
        "contract_address": "0xb0423e6e54afea1658ce4ced53971575c99d6cad",
        "receipt": "0xf9070901831b4254b9010000400000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000008000000000000000000000000820000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000020000000040000000000000000000000880000000000800000000f905fef85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba043cbead5e9cdd6fef63d3c51cd82da287795b2a519273f39ec526e11969bccecf85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba091d0383df14829a9f6c505ee14de8c05c3fab62b2b44954f14b0c7dc9c4fe55ef87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000000934ec443eafd5ab2fa6e8db57d9bea0a334013eaac35f028e7da41711ca2fb28f87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000001da8099cad6b92df9fc36a552a23445ae60527cba86362fb0b53c9691eb4d62f3f85894b0423e6e54afea1658ce4ced53971575c99d6cade1a048ea34bbce4a95382a77a55f86a31c66a0719a0d4baed17727e5b0276ebb6e7ba00f7eac23578c0e30e52a12fe217538a51b52281c14e5b8e7f331a23257075bb5f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a0ab894f958fb0dddc50af77f5a19e18b590035cb8eed8c469ec21ffda0ccc56acb01374627f2e2ddd386e1e5b0d04a22cf4aa16af297f7723e71963b1762f269cea128da6371fd65248541c1247989acf7bd1ba0917bfe5a35561f85d95b6c8be8a0d32b922672210052c4b0f806f0b902de795eaae57091c85d38a368c7d329084ddd98a69a324e636efce637ea149a0f537fe8242005f8284f26dda2d2f56d80df22bef32626d018566549ddeaab5ef3434439effcc05173f3dbc564122f854f3c9e89ec4576661e783c1bf760fd103efc1c2157e1a4bff1e62feb675c26811555bd4a929feef9f66b67ce1376a860e417fd179d62dee3344d72417cbd3feabc18e0f83c00af15a81a0944d6e2d020a7adbd844336fa87dd573f3ac9d8233037acc07cdf380ed7cda4b710a931830659dbee22ec25f1c551c169d7e8d752eb1b33c5fbd7134e037aee00000000000000000000000000000000000000000000f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a7548f71df3b0ab6f0f9cbe7b6e8032a6f7190083f8d7d9fc2ab760ce2f0d8f6d5c030184ac07cdc497e6ac98097270c0ad8deab9b22e2d21c56c65317325b098c9ebc44c42189916a8aef5eec3e7ef7d846f84dac75dbf0de9a7e5f557cf6b486130535a46f80abfac7b32c9e7393128ea275446758cd10e48ec487565368d3cbb1b681287b64faa50742cf5a3463be5bf30503899ad9c209db28922a7dc7c3c7e074d103cc7a70f1c8f382bc841555f0dac78330dbbd8449a027dff92e8c5d0aeb46f95bf452fdf77d5a3031d282eab4fc647d1e94879d210311d4013d3cdf7f5dc78ea3f9393850b9112c3b3dafe8a992e9b72473629d5c05d6a555824c1a99fb356491741783e3107e590b637dfbd2ee76a797656e2a80d944774223c48d48deffe5f48cfc4c93928d562c3d7e860866b70b690202afa2391faf780a55fe0c8bb8725010f03de066b00000000000000000000000000000000000000000000",
        "address": "0",
        "commitment": "0x934ec443eafd5ab2fa6e8db57d9bea0a334013eaac35f028e7da41711ca2fb28"
    },
]
INCORRECT_COMMITMENT = {
    "contract_address": "0xb0423e6e54afea1658ce4ced53971575c99d6cad",
    "receipt": "0xf9070901831b4254b9010000400000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000008000000000000000000000000820000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000020000000040000000000000000000000880000000000800000000f905fef85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba043cbead5e9cdd6fef63d3c51cd82da287795b2a519273f39ec526e11969bccecf85894b0423e6e54afea1658ce4ced53971575c99d6cade1a05437319c2e8822235e293114788c82212d6324650c93724a8da365118e0482fba091d0383df14829a9f6c505ee14de8c05c3fab62b2b44954f14b0c7dc9c4fe55ef87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000000934ec443eafd5ab2fa6e8db57d9bea0a334013eaac35f028e7da41711ca2fb28f87994b0423e6e54afea1658ce4ced53971575c99d6cade1a09071fb9c65294569ea45ba733587f29f9718e4755169f08c5abb6be43b50a5acb8400000000000000000000000000000000000000000000000000000000000000001da8099cad6b92df9fc36a552a23445ae60527cba86362fb0b53c9691eb4d62f3f85894b0423e6e54afea1658ce4ced53971575c99d6cade1a048ea34bbce4a95382a77a55f86a31c66a0719a0d4baed17727e5b0276ebb6e7ba00f7eac23578c0e30e52a12fe217538a51b52281c14e5b8e7f331a23257075bb5f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a0ab894f958fb0dddc50af77f5a19e18b590035cb8eed8c469ec21ffda0ccc56acb01374627f2e2ddd386e1e5b0d04a22cf4aa16af297f7723e71963b1762f269cea128da6371fd65248541c1247989acf7bd1ba0917bfe5a35561f85d95b6c8be8a0d32b922672210052c4b0f806f0b902de795eaae57091c85d38a368c7d329084ddd98a69a324e636efce637ea149a0f537fe8242005f8284f26dda2d2f56d80df22bef32626d018566549ddeaab5ef3434439effcc05173f3dbc564122f854f3c9e89ec4576661e783c1bf760fd103efc1c2157e1a4bff1e62feb675c26811555bd4a929feef9f66b67ce1376a860e417fd179d62dee3344d72417cbd3feabc18e0f83c00af15a81a0944d6e2d020a7adbd844336fa87dd573f3ac9d8233037acc07cdf380ed7cda4b710a931830659dbee22ec25f1c551c169d7e8d752eb1b33c5fbd7134e037aee00000000000000000000000000000000000000000000f901fa94b0423e6e54afea1658ce4ced53971575c99d6cade1a0ae9e21c10a4c87244f42726d81254d8dcb927fca81bc92a93decc140001227e4b901c0d3ae89451e7ffe998fcde46754216373a7d78662b8163909f809c905ca04fc730000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000014a7548f71df3b0ab6f0f9cbe7b6e8032a6f7190083f8d7d9fc2ab760ce2f0d8f6d5c030184ac07cdc497e6ac98097270c0ad8deab9b22e2d21c56c65317325b098c9ebc44c42189916a8aef5eec3e7ef7d846f84dac75dbf0de9a7e5f557cf6b486130535a46f80abfac7b32c9e7393128ea275446758cd10e48ec487565368d3cbb1b681287b64faa50742cf5a3463be5bf30503899ad9c209db28922a7dc7c3c7e074d103cc7a70f1c8f382bc841555f0dac78330dbbd8449a027dff92e8c5d0aeb46f95bf452fdf77d5a3031d282eab4fc647d1e94879d210311d4013d3cdf7f5dc78ea3f9393850b9112c3b3dafe8a992e9b72473629d5c05d6a555824c1a99fb356491741783e3107e590b637dfbd2ee76a797656e2a80d944774223c48d48deffe5f48cfc4c93928d562c3d7e860866b70b690202afa2391faf780a55fe0c8bb8725010f03de066b00000000000000000000000000000000000000000000",
    "address": "2",
    "commitment": "0xda8099cad6b92df9fc36a552a23445ae60527cba86362fb0b53c9691eb4d62f3"
}

contract('ZethCommitmentEventVerifier.js', (accounts) => {
    let verifier;

    before("deploy verifier", async () => {
        verifier = await Verifier.new();
    })

    describe('Verify Commitment Event', () => {
        it('Successful Verification', async () => {
            for (let i = 0; i < EXPECTED_COMMITMENTS.length; i++) {
                expected_commitment = EXPECTED_COMMITMENTS[i]
                let verified = await verifier.verify.call(expected_commitment.contract_address, expected_commitment.receipt, expected_commitment.address, expected_commitment.commitment);
                await verifier.verify(expected_commitment.contract_address, expected_commitment.receipt, expected_commitment.address, expected_commitment.commitment);

                assert(verified);
            }
        })

        it('Fail Verification with incorrect data', async () => {
            await verifier.verify(INCORRECT_COMMITMENT.contract_address, INCORRECT_COMMITMENT.receipt, INCORRECT_COMMITMENT.address, INCORRECT_COMMITMENT.commitment).should.be.rejected;
        })
    })
})